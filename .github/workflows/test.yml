name: CI

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  FOUNDRY_PROFILE: ci
  FOUNDRY_TEST_TIMEOUT: 100000
  FOUNDRY_FUZZ_RUNS: 10
  FOUNDRY_FUZZ_DICTIONARY_WEIGHT: 80
  FOUNDRY_FUZZ_MAX_TEST_REJECTS: 65536
  FOUNDRY_FUZZ_SEED: 1234
  FOUNDRY_FORK_URL: https://eth-sepolia.g.alchemy.com/v2/demo
  FOUNDRY_FORK_BLOCK_NUMBER: 5000000

defaults:
  run:
    shell: bash

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Show versions
        run: |
          forge --version
          cast --version
          anvil --version
          chisel --version

      - name: Install dependencies
        run: forge install

      - name: Check formatting
        run: forge fmt --check

      - name: Build contracts
        run: forge build

      - name: Run unit tests
        run: forge test -vvv --no-match-contract "Fork"

      - name: Run fork tests
        if: ${{ !cancelled() }}
        run: |
          forge test --match-contract "Fork" -vvv --fork-url $FOUNDRY_FORK_URL --fork-block-number $FOUNDRY_FORK_BLOCK_NUMBER

      - name: Generate coverage report
        if: ${{ !cancelled() }}
        run: |
          mkdir -p coverage
          forge coverage --report lcov --report summary
          genhtml lcov.info --branch-coverage --output-dir coverage

      - name: Upload coverage report
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v4
        with:
          file: lcov.info
          flags: unittests
          fail_ci_if_error: false

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Install Solhint
        run: npm install -g solhint

      - name: Run Solhint
        run: solhint --max-warnings 0 'src/**/*.sol'

  slither:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Slither
        run: |
          pip install slither-analyzer
          solc-select install 0.8.20
          solc-select use 0.8.20

      - name: Run Slither
        run: |
          slither . --exclude-dependencies --filter-paths "test|script|lib"

  gas-report:
    name: Gas Report
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: foundry-rs/foundry-toolchain@v1
      - run: forge test --gas-report --match-test "testFuzz_" -vvv

  verify:
    name: Verify Build
    runs-on: ubuntu-latest
    needs: [test, lint, slither]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @solarity/hardhat-markup
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            out/
            cache/
            .build/
            .gitmodules
            .git/
          if-no-files-found: error
